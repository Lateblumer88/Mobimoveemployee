pipeline {
	agent any
	
	environment {
	registry = "mobimimi/mobimove-employee-api"
	registruCredentialID = 'dockerId'
	dockerImage = ''
	projectname = 'mobimoveEmployee'
	projectDirectory = '/opt/${env.projectname}'
	
	}
	stages {
	
	
	
	
		stage('Compilation stage'){
			
			steps {
				withMaven(maven :	'3.6.3') {
					sh 'mvn clean compile'
				}
			}
		}
		
		stage('Testing stage'){
			
			steps {
			
				withMaven(maven : '3.6.3') {
				
					sh 'mvn test'
				}
			
			}
		
		}
		
		stage('Build and create jar file stage') {
		
			steps {
				withMaven(maven	: '3.6.3') {
					sh	'mvn clean package -Dmaven.test.skip=true'
					
				}
			
			}
		}
		
		
		stage('Connecting to git repo') {
		
			steps {
					checkout scm
			}
		}
		
		
		stage('Build Docker Image') {
		
				steps {
					script{
					//	sh "echo $PATH"
					//dockerImage =	 docker.build('${env.PROJECT}-${env.POM_VERSION}')
					dockerImage =	 docker.build('mobimove-employee-api-${BUILD_NUMBER}')
							sh "echo $PATH"
					}
				}
		
		}
		
		stage ('Deploy to folder'){
		
				steps {
					script {
						
						if(!fileExists("${env.projectDirectory}"))
						{
						
						dir ('${env.projectDirectory}') {
        					writeFile file:'dummy', text:''
        					//sh 'cp dockerImage  ${env.projectDirectory}'
        					//sh 'ls -l'
    					}
						
						
  							//sh 'cd /opt/ '
  							//sh 'ls'
							//sh 'mkdir ${env.projectname}'
						
							//sh 'cp dockerImage  ${env.projectDirectory}'
						}else {
						
							//sh 'cp dockerImage  ${env.projectDirectory}'
						}
					
					}
				
				}
		
		
		
		}
		
		stage ('Create container and deploy') {
		
			steps {
				script {
					sh 'docker run -d -p 7575:7575 --name  mobimoveEmployeeApi mobimove-employee-api-${BUILD_NUMBER}'
					//sh 'docker run -d -p 8080:8080 --name  ${env.PROJECT} ${env.PROJECT}-${env.POM_VERSION}'
				
				}
			
			}
		
		
		}
		
		
		//stage('Deploy Image') {
			//steps {
				//script {
					
					// docker.withRegistry('https://registry.hub.docker.com', 'dockerhubID') {
				 	//	dockerImage.push()
					// }
				
				//}
			
			//}
		
		//}
	//This is a test to see if authomatic trigger is running.
	}
}